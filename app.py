import streamlit as st
import pandas as pd
import numpy as np
import yfinance as yf
import plotly.graph_objects as go
from plotly.subplots import make_subplots
from datetime import datetime, timedelta
import ta
from typing import Dict, Tuple, List

# Configura√ß√£o da p√°gina
st.set_page_config(
    page_title="Analisador de Criptomoedas",
    page_icon="‚Çø",
    layout="wide",
    initial_sidebar_state="expanded"
)

# Classe principal do analisador
class CryptoAnalyzer:
    def __init__(self):
        self.crypto_symbols = {
            "Bitcoin": "BTC-USD",
            "Ethereum": "ETH-USD", 
            "Binance Coin": "BNB-USD",
            "Cardano": "ADA-USD",
            "Solana": "SOL-USD",
            "XRP": "XRP-USD",
            "Dogecoin": "DOGE-USD",
            "Polygon": "MATIC-USD",
            "Polkadot": "DOT-USD",
            "Avalanche": "AVAX-USD"
        }
        
    def get_crypto_data(self, symbol: str, period: str = "6mo") -> pd.DataFrame:
        """Busca dados da criptomoeda usando yfinance"""
        try:
            ticker = yf.Ticker(symbol)
            data = ticker.history(period=period)
            return data
        except Exception as e:
            st.error(f"Erro ao buscar dados para {symbol}: {str(e)}")
            return pd.DataFrame()
    
    def calculate_ema(self, data: pd.DataFrame, periods: List[int]) -> pd.DataFrame:
        """Calcula m√∫ltiplas EMAs"""
        df = data.copy()
        for period in periods:
            df[f'EMA_{period}'] = ta.trend.EMAIndicator(
                close=df['Close'], window=period
            ).ema_indicator()
        return df
    
    def calculate_rsi(self, data: pd.DataFrame, period: int = 14) -> pd.DataFrame:
        """Calcula RSI"""
        df = data.copy()
        df['RSI'] = ta.momentum.RSIIndicator(
            close=df['Close'], window=period
        ).rsi()
        return df
    
    def calculate_stochastic_rsi(self, data: pd.DataFrame, 
                               k_period: int = 14, 
                               d_period: int = 3, 
                               rsi_period: int = 14) -> pd.DataFrame:
        """Calcula RSI Estoc√°stico"""
        df = data.copy()
        
        # Primeiro calcula o RSI
        rsi = ta.momentum.RSIIndicator(close=df['Close'], window=rsi_period).rsi()
        
        # Calcula o Stochastic RSI
        stoch_rsi = ta.momentum.StochRSIIndicator(
            close=df['Close'], 
            window=rsi_period, 
            smooth1=k_period, 
            smooth2=d_period
        )
        
        df['StochRSI_K'] = stoch_rsi.stochrsi_k() * 100
        df['StochRSI_D'] = stoch_rsi.stochrsi_d() * 100
        
        return df
    
    def apply_strategy(self, data: pd.DataFrame, 
                      ema_fast: int, ema_slow: int,
                      rsi_oversold: int = 30, rsi_overbought: int = 70,
                      stoch_oversold: int = 20, stoch_overbought: int = 80) -> pd.DataFrame:
        """Aplica a estrat√©gia de trading"""
        df = data.copy()
        
        # Sinais de EMA
        df['EMA_Signal'] = np.where(df[f'EMA_{ema_fast}'] > df[f'EMA_{ema_slow}'], 1, -1)
        
        # Sinais de RSI
        df['RSI_Signal'] = np.where(
            df['RSI'] < rsi_oversold, 1,  # Compra quando oversold
            np.where(df['RSI'] > rsi_overbought, -1, 0)  # Vende quando overbought
        )
        
        # Sinais de Stochastic RSI
        df['StochRSI_Signal'] = np.where(
            (df['StochRSI_K'] < stoch_oversold) & (df['StochRSI_D'] < stoch_oversold), 1,
            np.where(
                (df['StochRSI_K'] > stoch_overbought) & (df['StochRSI_D'] > stoch_overbought), -1, 0
            )
        )
        
        # Sinal combinado (estrat√©gia)
        df['Combined_Signal'] = np.where(
            (df['EMA_Signal'] == 1) & 
            (df['RSI_Signal'] == 1) & 
            (df['StochRSI_Signal'] == 1), 1,  # COMPRA forte
            np.where(
                (df['EMA_Signal'] == -1) & 
                (df['RSI_Signal'] == -1) & 
                (df['StochRSI_Signal'] == -1), -1,  # VENDA forte
                np.where(
                    (df['EMA_Signal'] == 1) & 
                    ((df['RSI_Signal'] == 1) | (df['StochRSI_Signal'] == 1)), 0.5,  # COMPRA moderada
                    np.where(
                        (df['EMA_Signal'] == -1) & 
                        ((df['RSI_Signal'] == -1) | (df['StochRSI_Signal'] == -1)), -0.5, 0  # VENDA moderada
                    )
                )
            )
        )
        
        return df
    
    def get_latest_signals(self, data: pd.DataFrame) -> Dict:
        """Obt√©m os sinais mais recentes"""
        if data.empty:
            return {}
        
        latest = data.iloc[-1]
        return {
            'price': latest['Close'],
            'ema_signal': latest['EMA_Signal'],
            'rsi': latest['RSI'],
            'rsi_signal': latest['RSI_Signal'],
            'stoch_k': latest['StochRSI_K'],
            'stoch_d': latest['StochRSI_D'],
            'stoch_signal': latest['StochRSI_Signal'],
            'combined_signal': latest['Combined_Signal']
        }

def create_chart(data: pd.DataFrame, crypto_name: str, ema_periods: List[int]) -> go.Figure:
    """Cria gr√°fico interativo com Plotly"""
    fig = make_subplots(
        rows=4, cols=1,
        shared_xaxes=True,
        vertical_spacing=0.03,
        subplot_titles=(
            f'{crypto_name} - Pre√ßo e EMAs',
            'RSI',
            'Stochastic RSI',
            'Sinais Combinados'
        ),
        row_heights=[0.5, 0.2, 0.2, 0.1]
    )
    
    # Gr√°fico de pre√ßo e EMAs
    fig.add_trace(
        go.Candlestick(
            x=data.index,
            open=data['Open'],
            high=data['High'],
            low=data['Low'],
            close=data['Close'],
            name='Pre√ßo'
        ),
        row=1, col=1
    )
    
    # EMAs
    colors = ['orange', 'blue', 'green', 'red', 'purple']
    for i, period in enumerate(ema_periods):
        fig.add_trace(
            go.Scatter(
                x=data.index,
                y=data[f'EMA_{period}'],
                name=f'EMA {period}',
                line=dict(color=colors[i % len(colors)])
            ),
            row=1, col=1
        )
    
    # RSI
    fig.add_trace(
        go.Scatter(
            x=data.index,
            y=data['RSI'],
            name='RSI',
            line=dict(color='purple')
        ),
        row=2, col=1
    )
    
    # Linhas de refer√™ncia RSI
    fig.add_hline(y=70, line_dash="dash", line_color="red", row=2, col=1)
    fig.add_hline(y=30, line_dash="dash", line_color="green", row=2, col=1)
    fig.add_hline(y=50, line_dash="dot", line_color="gray", row=2, col=1)
    
    # Stochastic RSI
    fig.add_trace(
        go.Scatter(
            x=data.index,
            y=data['StochRSI_K'],
            name='Stoch RSI %K',
            line=dict(color='blue')
        ),
        row=3, col=1
    )
    
    fig.add_trace(
        go.Scatter(
            x=data.index,
            y=data['StochRSI_D'],
            name='Stoch RSI %D',
            line=dict(color='orange')
        ),
        row=3, col=1
    )
    
    # Linhas de refer√™ncia Stochastic RSI
    fig.add_hline(y=80, line_dash="dash", line_color="red", row=3, col=1)
    fig.add_hline(y=20, line_dash="dash", line_color="green", row=3, col=1)
    
    # Sinais combinados
    colors_signal = {1: 'green', 0.5: 'lightgreen', 0: 'gray', -0.5: 'orange', -1: 'red'}
    
    for signal_value, color in colors_signal.items():
        signal_data = data[data['Combined_Signal'] == signal_value]
        if not signal_data.empty:
            fig.add_trace(
                go.Scatter(
                    x=signal_data.index,
                    y=[signal_value] * len(signal_data),
                    mode='markers',
                    name=f'Signal {signal_value}',
                    marker=dict(color=color, size=8),
                    showlegend=False
                ),
                row=4, col=1
            )
    
    fig.update_layout(
        title=f'An√°lise T√©cnica - {crypto_name}',
        xaxis_rangeslider_visible=False,
        height=800,
        showlegend=True
    )
    
    return fig

def main():
    st.title("‚Çø Analisador de Criptomoedas")
    st.markdown("**An√°lise t√©cnica usando EMA, RSI e RSI Estoc√°stico**")
    
    # Inicializar analisador
    analyzer = CryptoAnalyzer()
    
    # Sidebar para configura√ß√µes
    st.sidebar.header("‚öôÔ∏è Configura√ß√µes")
    
    # Sele√ß√£o da criptomoeda
    crypto_name = st.sidebar.selectbox(
        "Escolha a Criptomoeda:",
        options=list(analyzer.crypto_symbols.keys()),
        index=0
    )
    
    # Per√≠odo de dados
    period = st.sidebar.selectbox(
        "Per√≠odo de An√°lise:",
        options=["1mo", "3mo", "6mo", "1y", "2y"],
        index=2
    )
    
    # Configura√ß√µes de EMA
    st.sidebar.subheader("üìà Configura√ß√µes EMA")
    ema_fast = st.sidebar.number_input("EMA R√°pida", min_value=5, max_value=50, value=12)
    ema_slow = st.sidebar.number_input("EMA Lenta", min_value=20, max_value=200, value=26)
    ema_trend = st.sidebar.number_input("EMA Tend√™ncia", min_value=50, max_value=300, value=200)
    
    # Configura√ß√µes RSI
    st.sidebar.subheader("üìä Configura√ß√µes RSI")
    rsi_period = st.sidebar.number_input("Per√≠odo RSI", min_value=10, max_value=30, value=14)
    rsi_oversold = st.sidebar.number_input("RSI Sobrevenda", min_value=20, max_value=40, value=30)
    rsi_overbought = st.sidebar.number_input("RSI Sobrecompra", min_value=60, max_value=80, value=70)
    
    # Configura√ß√µes Stochastic RSI
    st.sidebar.subheader("üìâ Configura√ß√µes Stoch RSI")
    stoch_k = st.sidebar.number_input("Per√≠odo %K", min_value=10, max_value=20, value=14)
    stoch_d = st.sidebar.number_input("Per√≠odo %D", min_value=3, max_value=10, value=3)
    stoch_oversold = st.sidebar.number_input("Stoch Sobrevenda", min_value=10, max_value=30, value=20)
    stoch_overbought = st.sidebar.number_input("Stoch Sobrecompra", min_value=70, max_value=90, value=80)
    
    # Bot√£o para an√°lise
    if st.sidebar.button("üöÄ Analisar", type="primary"):
        with st.spinner(f"Analisando {crypto_name}..."):
            # Buscar dados
            symbol = analyzer.crypto_symbols[crypto_name]
            data = analyzer.get_crypto_data(symbol, period)
            
            if not data.empty:
                # Calcular indicadores
                ema_periods = [ema_fast, ema_slow, ema_trend]
                data = analyzer.calculate_ema(data, ema_periods)
                data = analyzer.calculate_rsi(data, rsi_period)
                data = analyzer.calculate_stochastic_rsi(data, stoch_k, stoch_d, rsi_period)
                data = analyzer.apply_strategy(
                    data, ema_fast, ema_slow, 
                    rsi_oversold, rsi_overbought,
                    stoch_oversold, stoch_overbought
                )
                
                # Obter sinais atuais
                signals = analyzer.get_latest_signals(data)
                
                # Layout principal
                col1, col2, col3 = st.columns(3)
                
                with col1:
                    st.metric(
                        "Pre√ßo Atual",
                        f"${signals['price']:.2f}",
                        delta=f"{((signals['price'] - data['Close'].iloc[-2]) / data['Close'].iloc[-2] * 100):.2f}%"
                    )
                
                with col2:
                    st.metric("RSI", f"{signals['rsi']:.1f}")
                
                with col3:
                    signal_text = {
                        1: "üü¢ COMPRA FORTE",
                        0.5: "üü° COMPRA MODERADA", 
                        0: "‚ö™ NEUTRO",
                        -0.5: "üü† VENDA MODERADA",
                        -1: "üî¥ VENDA FORTE"
                    }
                    st.metric("Sinal", signal_text.get(signals['combined_signal'], "‚ùì"))
                
                # Gr√°fico principal
                chart = create_chart(data, crypto_name, ema_periods)
                st.plotly_chart(chart, use_container_width=True)
                
                # An√°lise detalhada
                st.subheader("üìã An√°lise Detalhada")
                
                col1, col2 = st.columns(2)
                
                with col1:
                    st.write("**Indicadores Atuais:**")
                    st.write(f"‚Ä¢ EMA {ema_fast}: ${data[f'EMA_{ema_fast}'].iloc[-1]:.2f}")
                    st.write(f"‚Ä¢ EMA {ema_slow}: ${data[f'EMA_{ema_slow}'].iloc[-1]:.2f}")
                    st.write(f"‚Ä¢ EMA {ema_trend}: ${data[f'EMA_{ema_trend}'].iloc[-1]:.2f}")
                    st.write(f"‚Ä¢ RSI: {signals['rsi']:.1f}")
                    st.write(f"‚Ä¢ Stoch RSI %K: {signals['stoch_k']:.1f}")
                    st.write(f"‚Ä¢ Stoch RSI %D: {signals['stoch_d']:.1f}")
                
                with col2:
                    st.write("**Interpreta√ß√£o:**")
                    
                    # EMA
                    if signals['ema_signal'] == 1:
                        st.write("üü¢ **Tend√™ncia:** Alta (EMA r√°pida > EMA lenta)")
                    else:
                        st.write("üî¥ **Tend√™ncia:** Baixa (EMA r√°pida < EMA lenta)")
                    
                    # RSI
                    if signals['rsi'] < rsi_oversold:
                        st.write("üü¢ **RSI:** Sobrevenda - Poss√≠vel compra")
                    elif signals['rsi'] > rsi_overbought:
                        st.write("üî¥ **RSI:** Sobrecompra - Poss√≠vel venda")
                    else:
                        st.write("üü° **RSI:** Zona neutra")
                    
                    # Stoch RSI
                    if signals['stoch_k'] < stoch_oversold:
                        st.write("üü¢ **Stoch RSI:** Sobrevenda")
                    elif signals['stoch_k'] > stoch_overbought:
                        st.write("üî¥ **Stoch RSI:** Sobrecompra")
                    else:
                        st.write("üü° **Stoch RSI:** Zona neutra")
                
                # Resumo da estrat√©gia
                st.subheader("üìñ Resumo da Estrat√©gia")
                st.info("""
                **Estrat√©gia Utilizada:**
                
                üü¢ **COMPRA FORTE**: EMA r√°pida > EMA lenta + RSI em sobrevenda + Stoch RSI em sobrevenda
                
                üü° **COMPRA MODERADA**: EMA r√°pida > EMA lenta + (RSI em sobrevenda OU Stoch RSI em sobrevenda)
                
                üî¥ **VENDA FORTE**: EMA r√°pida < EMA lenta + RSI em sobrecompra + Stoch RSI em sobrecompra
                
                üü† **VENDA MODERADA**: EMA r√°pida < EMA lenta + (RSI em sobrecompra OU Stoch RSI em sobrecompra)
                
                ‚ö™ **NEUTRO**: Demais condi√ß√µes
                """)
    
    # Informa√ß√µes adicionais
    st.sidebar.markdown("---")
    st.sidebar.markdown("**üí° Dica:** Ajuste os par√¢metros conforme sua estrat√©gia de trading.")
    st.sidebar.markdown("**‚ö†Ô∏è Aviso:** Este n√£o √© um conselho financeiro. Sempre fa√ßa sua pr√≥pria pesquisa.")

if __name__ == "__main__":
    main()